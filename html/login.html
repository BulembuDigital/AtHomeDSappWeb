<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Login · At Home Driving School</title>

  <!-- Icons -->
  <link rel="icon" type="image/png" href="/icons/favicon-32.png">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">

  <!-- Styles -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/auth.css">
  <link rel="stylesheet" href="/css/ui-sparkle.css">
  <link rel="stylesheet" href="/css/splash.css">

  <!-- Theme system -->
  <script defer src="/js/theme.js"></script>
  <script defer src="/js/ui-sparkle.js"></script>
  <script defer src="/js/splash.js"></script>

  <!-- Supabase -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- SDK -->
  <script type="module" src="/js/supabaseClient.js"></script>
  <script type="module" src="/js/sdk/auth.js"></script>
  <script type="module" src="/js/sdk/profiles.js"></script>

  <style>
    .login-wrap {
      max-width: 420px;
      width: 100%;
      margin-inline: auto;
      padding: 40px 20px;
    }
    .logo-big {
      width: 110px;
      height: 110px;
      object-fit: contain;
      margin-bottom: 10px;
      filter: drop-shadow(0 0 22px rgba(59,130,246,0.45));
      animation: pulse 2.4s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: .9; }
      50%     { transform: scale(1.06); opacity: 1; }
    }
  </style>
</head>

<body class="soft-page">

<!-- Splash Screen -->
<div class="splash-overlay show">
  <div class="splash">
    <div class="logo-wrap">
      <img class="logo" src="/icons/logo-512.png" alt="Logo">
      <div class="glow"></div>
      <div class="bloom"></div>
    </div>
    <div class="loader">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>
</div>

<div class="auth-container soft-page">
  <div class="auth-card login-wrap">

    <div class="center">
      <img src="/icons/logo-512.png" alt="Logo" class="logo-big">
    </div>

    <h1>Welcome Back</h1>
    <p>Enter your email address to receive your secure login link.</p>

    <div class="auth-form">

      <div class="field">
        <span>Email Address</span>
        <input id="email" type="email" placeholder="you@mail.com"/>
      </div>

      <button id="loginBtn" class="btn-primary">Send Login Link</button>

      <div class="small" style="text-align:center; margin-top:14px; opacity:.8;">
        No account yet?
        <a href="/html/signup.html" class="btn-link">Create one</a>
      </div>

      <div id="result"></div>

    </div>

  </div>
</div>

<script type="module">
  import { signInWithMagicLink, getSession } from "/js/sdk/auth.js";
  import { getProfileById } from "/js/sdk/profiles.js";

  // Auto-route already logged-in users
  (async function routeIfLoggedIn() {
    const { userId } = await getSession();
    if (!userId) return;

    const profile = await getProfileById(userId);
    if (!profile) return;

    if (profile.status === "approved") {
      location.href = path(profile.role);
    } else {
      location.href = "/html/pending.html";
    }
  })();

  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("email").value.trim();
    const result = document.getElementById("result");

    if (!email) {
      result.innerHTML = `<span class="notice-err">Enter a valid email.</span>`;
      return;
    }

    result.innerHTML = `<span class="muted">Sending…</span>`;

    try {
      const res = await signInWithMagicLink(email);

      if (!res.ok) {
        result.innerHTML = `<span class="notice-err">${res.error || "Error sending magic link."}</span>`;
        return;
      }

      result.innerHTML =
        `<span class="notice-ok">Check your email for the login link.</span>`;

    } catch (err) {
      result.innerHTML = `<span class="notice-err">${err.message}</span>`;
    }
  };

  function path(role) {
    switch (role) {
      case "Supervisor": return "/html/supervisor.html";
      case "Admin": return "/html/admin.html";
      case "Manager": return "/html/manager.html";
      case "Team Leader": return "/html/team-leader.html";
      case "Instructor": return "/html/instructor.html";
      case "Client": return "/html/client.html";
      default: return "/html/login.html";
    }
  }
</script>

</body>
</html>
