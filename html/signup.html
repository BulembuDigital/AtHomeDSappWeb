<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Create Account</title>

  <!-- Icons -->
  <link rel="icon" type="image/png" href="/icons/favicon-32.png">
  <link rel="apple-touch-icon" href="/icons/apple-icon-180.png">

  <!-- Base UI -->
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/auth.css">
  <link rel="stylesheet" href="/css/ui-sparkle.css">
  <link rel="stylesheet" href="/css/splash.css">

  <!-- Theme + FX -->
  <script defer src="/js/theme.js"></script>
  <script defer src="/js/ui-sparkle.js"></script>
  <script defer src="/js/splash.js"></script>

  <!-- Supabase -->
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- SDK -->
  <script type="module" src="/js/supabaseClient.js"></script>
  <script type="module" src="/js/sdk/auth.js"></script>
  <script type="module" src="/js/sdk/profiles.js"></script>

  <style>
    /* Override for this page only */
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
    }
  </style>
</head>

<body class="soft-page">

<div class="auth-container">
  <div class="auth-card ready-pulse">
    
    <h1>Create Your Account</h1>
    <p>Fill in your details to submit your profile for approval.</p>

    <form class="auth-form">

      <div class="field">
        <span>Full Name</span>
        <input id="name" placeholder="Your full name">
      </div>

      <div class="field">
        <span>Select Role</span>
        <select id="role">
          <option value="">Select role</option>
          <option value="Client">Client</option>
          <option value="Instructor">Instructor</option>
          <option value="Team Leader">Team Leader</option>
          <option value="Manager">Manager</option>
          <option value="Admin">Admin</option>
          <option value="Supervisor">Supervisor</option>
        </select>
      </div>

      <!-- Supervisor Key -->
      <div class="field" id="supervisorKeyWrap" style="display:none;">
        <span>Supervisor Key</span>
        <input id="supervisorKey" placeholder="Enter supervisor key">
      </div>

      <!-- Zone -->
      <div class="field">
        <span>Zone (optional)</span>
        <select id="zone">
          <option value="">None</option>
          <option value="CUT">CUT</option>
          <option value="UFS">UFS</option>
        </select>
      </div>

      <div class="field">
        <span>Phone Number</span>
        <input id="phone" placeholder="+27…" />
      </div>

      <button id="saveBtn" class="btn-primary">Submit Profile</button>
    </form>

    <div id="result"></div>

    <p class="auth-footer">
      Already registered?
      <a class="btn-link" href="/html/login.html">Log in</a>
    </p>

  </div>
</div>

<script type="module">
  import { getSession } from "/js/sdk/auth.js";
  import { updateProfile, getProfileById } from "/js/sdk/profiles.js";

  // Replace with your real supervisor key
  const SUPERVISOR_KEY = "ABC123";

  // Auto-route if already completed
  (async function init() {
    const { userId } = await getSession();
    if (!userId) return location.href = "/html/login.html";

    const profile = await getProfileById(userId);

    if (profile?.status === "approved") {
      return location.href = dashboardPath(profile.role);
    }
    if (profile?.status === "pending") {
      return location.href = "/html/pending.html";
    }
  })();

  // Show/hide supervisor key box
  const roleEl = document.getElementById("role");
  const supervisorKeyWrap = document.getElementById("supervisorKeyWrap");

  roleEl.addEventListener("change", () => {
    supervisorKeyWrap.style.display =
      roleEl.value === "Supervisor" ? "block" : "none";
  });

  // Submit handler
  document.getElementById("saveBtn").addEventListener("click", async (e) => {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const role = roleEl.value;
    const phone = document.getElementById("phone").value.trim();
    const zone = document.getElementById("zone").value || null;

    const resultBox = document.getElementById("result");
    resultBox.innerHTML = "";

    if (!name || !role) {
      resultBox.innerHTML = `<div class="notice-err">Fill all required fields.</div>`;
      return;
    }

    if (role === "Supervisor") {
      const key = document.getElementById("supervisorKey").value.trim();
      if (!key || key !== SUPERVISOR_KEY) {
        resultBox.innerHTML =
          `<div class="notice-err">Invalid supervisor key.</div>`;
        return;
      }
    }

    try {
      await updateProfile({
        name,
        role,
        phone,
        zone,
        status: "pending"
      });

      resultBox.innerHTML =
        `<div class="notice-ok">Profile submitted. Await approval.</div>`;

      setTimeout(() => {
        location.href = "/html/pending.html";
      }, 800);

    } catch (err) {
      resultBox.innerHTML =
        `<div class="notice-err">${err.message}</div>`;
    }
  });

  // Role → dashboard mapping
  function dashboardPath(role) {
    switch (role) {
      case "Supervisor": return "/html/supervisor.html";
      case "Admin": return "/html/admin.html";
      case "Manager": return "/html/manager.html";
      case "Team Leader": return "/html/team-leader.html";
      case "Instructor": return "/html/instructor.html";
      case "Client": return "/html/client.html";
      default: return "/html/login.html";
    }
  }
</script>

</body>
</html>
